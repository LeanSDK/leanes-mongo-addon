"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("crypto")),o=require("mongodb"),i=t(require("mongo-parse"));var r=function(t,e,o,i,r){var n={};return Object.keys(i).forEach((function(t){n[t]=i[t]})),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=o.slice().reverse().reduce((function(o,i){return i(t,e,o)||o}),n),r&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(r):void 0,n.initializer=void 0),void 0===n.initializer&&(Object.defineProperty(t,e,n),n=null),n};var n=function(t,e,o,i){o&&Object.defineProperty(t,e,{enumerable:o.enumerable,configurable:o.configurable,writable:o.writable,value:o.initializer?o.initializer.call(i):void 0})},a=t=>{var e,o,i,a,s,l,c,p,u,y,d,h,b;const{CoreObject:w,initialize:m,partOf:g,meta:$,property:f,method:O,nameBy:j,injectable:x,inject:M,Utils:{_:v}}=t.NS;e=x(),o=g(t),i=M("CollectionFactory<*>"),m(a=e(a=o((b=h=class extends w{constructor(...t){super(...t),n(this,"_cursor",p,this),n(this,"_collection",u,this),n(this,"collectionName",y,this),n(this,"_collectionFactory",d,this)}get isClosed(){return null==this._cursor||(null==this._cursor.isClosed||this._cursor.isClosed())}setIterable(t){return this._cursor=t,this}setCollection(t){return this._collection=t,this}get collection(){return null!=this.collectionName?this._collectionFactory(this.collectionName):this._collection}async toArray(){const t=[];for(;await this.hasNext();)t.push(await this.next());return t}async next(){if(null==this._cursor)return;const t=await this._cursor.next();return await(null!=this.collection?this.collection.normalize(t):t)}async hasNext(){return await!this.isClosed&&await this._cursor.hasNext()}async close(){await Promise.resolve(null!=this._cursor?this._cursor.close():void 0)}async count(){return null==this._cursor?0:await await this._cursor.count(!0)}async forEach(t){let e=0;try{for(;await this.hasNext();)await t(await this.next(),e++)}catch(t){throw await this.close(),t}}async map(t){let e=0;try{const o=[];for(;await this.hasNext();)o.push(await t(await this.next(),e++));return o}catch(t){throw await this.close(),t}}async filter(t){let e=0;const o=[];try{for(;await this.hasNext();){const i=await this.next();await t(i,e++)&&o.push(i)}return o}catch(t){throw await this.close(),t}}async find(t){let e=0,o=null;try{for(;await this.hasNext();){const i=await this.next();if(await t(i,e++)){o=i;break}}return o}catch(t){throw await this.close(),t}}async compact(){if(null==this._cursor)return[];const t=[];try{for(;await this.hasNext();){const e=await this._cursor.next();if(!v.isEmpty(e)){const o=await(null!=this.collection?this.collection.normalize(e):e);t.push(o)}}return t}catch(t){throw await this.close(),t}}async reduce(t,e){try{let o=0,i=e;for(;await this.hasNext();)i=await t(i,await this.next(),o++);return i}catch(t){throw await this.close(),t}}async first(){try{const t=null!=await this.hasNext()?await this.next():null;return await this.close(),t}catch(t){throw await this.close(),t}}static async restoreObject(){throw new Error(`restoreObject method not supported for ${this.name}`)}static async replicateObject(){throw new Error(`replicateObject method not supported for ${this.name}`)}},h.__filename="/iterator/MongoCursor.js",h.object={},r(s=b,"__filename",[j],(l=(l=Object.getOwnPropertyDescriptor(s,"__filename"))?l.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return l}}),s),r(s,"object",[$],(c=(c=Object.getOwnPropertyDescriptor(s,"object"))?c.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return c}}),s),p=r(s.prototype,"_cursor",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),u=r(s.prototype,"_collection",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r(s.prototype,"isClosed",[f],Object.getOwnPropertyDescriptor(s.prototype,"isClosed"),s.prototype),r(s.prototype,"setIterable",[O],Object.getOwnPropertyDescriptor(s.prototype,"setIterable"),s.prototype),r(s.prototype,"setCollection",[O],Object.getOwnPropertyDescriptor(s.prototype,"setCollection"),s.prototype),y=r(s.prototype,"collectionName",[f],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),d=r(s.prototype,"_collectionFactory",[i,f],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r(s.prototype,"collection",[f],Object.getOwnPropertyDescriptor(s.prototype,"collection"),s.prototype),r(s.prototype,"toArray",[O],Object.getOwnPropertyDescriptor(s.prototype,"toArray"),s.prototype),r(s.prototype,"next",[O],Object.getOwnPropertyDescriptor(s.prototype,"next"),s.prototype),r(s.prototype,"hasNext",[O],Object.getOwnPropertyDescriptor(s.prototype,"hasNext"),s.prototype),r(s.prototype,"close",[O],Object.getOwnPropertyDescriptor(s.prototype,"close"),s.prototype),r(s.prototype,"count",[O],Object.getOwnPropertyDescriptor(s.prototype,"count"),s.prototype),r(s.prototype,"forEach",[O],Object.getOwnPropertyDescriptor(s.prototype,"forEach"),s.prototype),r(s.prototype,"map",[O],Object.getOwnPropertyDescriptor(s.prototype,"map"),s.prototype),r(s.prototype,"filter",[O],Object.getOwnPropertyDescriptor(s.prototype,"filter"),s.prototype),r(s.prototype,"find",[O],Object.getOwnPropertyDescriptor(s.prototype,"find"),s.prototype),r(s.prototype,"compact",[O],Object.getOwnPropertyDescriptor(s.prototype,"compact"),s.prototype),r(s.prototype,"reduce",[O],Object.getOwnPropertyDescriptor(s.prototype,"reduce"),s.prototype),r(s.prototype,"first",[O],Object.getOwnPropertyDescriptor(s.prototype,"first"),s.prototype),r(s,"restoreObject",[O],Object.getOwnPropertyDescriptor(s,"restoreObject"),s),r(s,"replicateObject",[O],Object.getOwnPropertyDescriptor(s,"replicateObject"),s),a=s))||a)||a)},s=t=>{const{initializeMixin:e,meta:o,property:i,method:a,inject:s,Utils:{jsonStringify:l}}=t.NS;t.defineMixin("/mixins/MongoCollectionMixin.js",(t=>{var l,c,p,u,y,d,h;return l=s("CursorFactory<*>"),e((h=d=class extends t{constructor(...t){super(...t),n(this,"_cursorFactory",y,this)}async takeMany(t){const e=await this.adapter.takeMany(this.delegate,t);return this._cursorFactory(this.getName(),e,"MongoCursor")}async takeAll(){const t=await this.adapter.takeAll(this.delegate);return this._cursorFactory(this.getName(),t,"MongoCursor")}},d.object={},r(p=h,"object",[o],(u=(u=Object.getOwnPropertyDescriptor(p,"object"))?u.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return u}}),p),y=r(p.prototype,"_cursorFactory",[l,i],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r(p.prototype,"takeMany",[a],Object.getOwnPropertyDescriptor(p.prototype,"takeMany"),p.prototype),r(p.prototype,"takeAll",[a],Object.getOwnPropertyDescriptor(p.prototype,"takeAll"),p.prototype),c=p))||c}))},l=t=>{const{initializeMixin:o,meta:i,property:n,method:a}=t.NS;t.defineMixin("/mixins/MongoSerializerMixin.js",(t=>{var n,s,l,c,p;return o((p=c=class extends t{async normalize(t,e){return e.rev=e._rev,e._rev=void 0,delete e._rev,await t.normalize(e,this.collection)}async serialize(t,o=null){const i=t.constructor,r=await i.serialize(t,o);r.rev=void 0;const n=e.createHash("md5");return n.update(JSON.stringify(r)),r._rev=n.digest("hex"),delete r.rev,r}},c.object={},r(s=p,"object",[i],(l=(l=Object.getOwnPropertyDescriptor(s,"object"))?l.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return l}}),s),r(s.prototype,"normalize",[a],Object.getOwnPropertyDescriptor(s.prototype,"normalize"),s.prototype),r(s.prototype,"serialize",[a],Object.getOwnPropertyDescriptor(s.prototype,"serialize"),s.prototype),n=s))||n}))},c=t=>{const{UP:e,DOWN:o,SUPPORTED_TYPES:i,Pipes:n,initializeMixin:a,meta:s,property:l,method:c,Utils:{_:p,jsonStringify:u}}=t.NS,{LogMessage:y}=n.NS,{SEND_TO_LOG:d,LEVELS:h,DEBUG:b}=y,w=async(t,e)=>await new Promise(((o,i)=>{t.collection(e,{strict:!0},((t,e)=>{null!=t?i(t):o(e)}))}));t.defineMixin("/mixins/MongoMigrationMixin.js",(t=>{var e,o,n,l,y;return a((y=l=class extends t{async createCollection(t,e){const o=this.collection.collectionFullName(t),i=await this.collection.adapter.connection;this.collection.send(d,`MongoMigrationMixin::createCollection qualifiedName = ${o}, options = ${u(e)}`,h[b]),await i.createCollection(o,e)}async createEdgeCollection(t,e,o){const i=this.collection.collectionFullName(`${t}_${e}`),r=await this.collection.adapter.connection;this.collection.send(d,`MongoMigrationMixin::createEdgeCollection qualifiedName = ${i}, options = ${u(o)}`,h[b]),await r.createCollection(i,o)}async addField(t,e,o){const i=this.collection.collectionFullName(t);if(p.isString(o))return;let r=null;if(r=null!=o.default?p.isNumber(o.default)||p.isBoolean(o.default)?o.default:p.isDate(o.default)?o.default.toISOString():p.isString(o.default)?`${o.default}`:null:null,null!=r){const t=await this.collection.adapter.connection;this.collection.send(d,`MongoMigrationMixin::addField qualifiedName = ${i}, $set: ${u({[`${e}`]:r})}`,h[b]);const o=await w(t,i);await o.updateMany({},{$set:{[`${e}`]:r},w:1})}}async addIndex(t,e,o){const i=this.collection.collectionFullName(t),r=await this.collection.adapter.connection,n=await w(r,i),a={};e.forEach((t=>{a[t]=1}));const s={unique:o.unique,sparse:o.sparse,background:o.background,name:o.name};this.collection.send(d,`MongoMigrationMixin::addIndex indexFields = ${u(a)}, opts = ${u(s)}`,h[b]),await n.ensureIndex(a,s)}async addTimestamps(t,e={}){}async changeCollection(t,e){}async changeField(t,e,o={}){const{json:r,binary:n,boolean:a,date:s,datetime:l,number:c,decimal:y,float:m,integer:g,primary_key:$,string:f,text:O,time:j,timestamp:x,array:M,hash:v}=i,_=this.collection.collectionFullName(t),N=await this.collection.adapter.connection,P=await w(N,_),D=await P.find().batchSize(1),F=p.isString(o)?o:o.type;for(;await D.hasNext();){const t=await D.next();let o=null;switch(F){case a:o=Boolean(t[e]);break;case y|m|g|c:o=Number(t[e]);break;case f|O|$|n|M:o=JSON.stringify(t[e]);break;case r|v:o=JSON.parse(String(t[e]));break;case s|l:o=new Date(t[e]).toISOString();break;case j|x:o=Number(new Date(t[e]))}}this.collection.send(d,`MongoMigrationMixin::changeField qualifiedName = ${_}, _id: ${u(document._id)}, $set: ${u({[`${e}`]:newValue})}`,h[b]),await P.updateOne({_id:document._id},{$set:{[`${e}`]:newValue}})}async renameField(t,e,o){const i=this.collection.collectionFullName(t),r=await this.collection.adapter.connection,n=await w(r,i);this.collection.send(d,`MongoMigrationMixin::renameField qualifiedName = ${i}, $rename: ${u({[`${oldFieldName}`]:o})}`,h[b]),await n.updateMany({},{$rename:{[`${oldFieldName}`]:o}})}async renameIndex(t,e,o){}async renameCollection(t,e){const o=this.collection.collectionFullName(t),i=this.collection.collectionFullName(e);this.collection.send(d,`MongoMigrationMixin::renameCollection qualifiedName = ${o}, newQualifiedName = ${i}`,h[b]);const r=await this.collection.adapter.connection,n=await w(r,o);await n.rename(i)}async dropCollection(t){const e=this.collection.collectionFullName(t),o=await this.collection.adapter.db;0!==(await o.listCollections({name:e}).toArray()).length&&(this.collection.send(d,`MongoMigrationMixin::dropCollection qualifiedName = ${e}`,h[b]),await o.dropCollection(e))}async dropEdgeCollection(t,e){const o=await this.collection.adapter.db,i=this.collection.collectionFullName(`${t}_${e}`);0!==(await o.listCollections({name:i}).toArray()).length&&(this.collection.send(d,`MongoMigrationMixin::dropEdgeCollection qualifiedName = ${i}`,h[b]),await o.dropCollection(i))}async removeField(t,e){const o=this.collection.collectionFullName(t),i=await this.collection.adapter.connection,r=await w(i,o);this.collection.send(d,`MongoMigrationMixin::removeField qualifiedName = ${o}, $unset: ${u({[`${e}`]:""})}`,h[b]),await r.updateMany({},{$unset:{[`${e}`]:""}},{w:1})}async removeIndex(t,e,o){const i=this.collection.collectionFullName(t),r=await this.collection.adapter.connection,n=await w(r,i),a=o.name;if(null==a){const t={};e.forEach((e=>{t[e]=1}));await n.ensureIndex(t,{unique:o.unique,sparse:o.sparse,background:o.background,name:o.name})}await n.indexExists(a)&&(this.collection.send(d,`MongoMigrationMixin::removeIndex qualifiedName = ${i}, indexName = ${a}, indexFields = ${u(indexFields)}, options = ${u(o)}`,h[b]),await n.dropIndex(a))}async removeTimestamps(t,e={}){const o=this.collection.collectionFullName(t),i=await this.collection.adapter.connection,r=await w(i,o),n={createdAt:null,updatedAt:null,deletedAt:null};this.collection.send(d,`MongoMigrationMixin::removeTimestamps qualifiedName = ${o}, $unset: ${u(n)}`,h[b]),await r.updateMany({},{$unset:n},{w:1})}},l.object={},r(o=y,"object",[s],(n=(n=Object.getOwnPropertyDescriptor(o,"object"))?n.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return n}}),o),r(o.prototype,"createCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"createCollection"),o.prototype),r(o.prototype,"createEdgeCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"createEdgeCollection"),o.prototype),r(o.prototype,"addField",[c],Object.getOwnPropertyDescriptor(o.prototype,"addField"),o.prototype),r(o.prototype,"addIndex",[c],Object.getOwnPropertyDescriptor(o.prototype,"addIndex"),o.prototype),r(o.prototype,"addTimestamps",[c],Object.getOwnPropertyDescriptor(o.prototype,"addTimestamps"),o.prototype),r(o.prototype,"changeCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"changeCollection"),o.prototype),r(o.prototype,"changeField",[c],Object.getOwnPropertyDescriptor(o.prototype,"changeField"),o.prototype),r(o.prototype,"renameField",[c],Object.getOwnPropertyDescriptor(o.prototype,"renameField"),o.prototype),r(o.prototype,"renameIndex",[c],Object.getOwnPropertyDescriptor(o.prototype,"renameIndex"),o.prototype),r(o.prototype,"renameCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"renameCollection"),o.prototype),r(o.prototype,"dropCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"dropCollection"),o.prototype),r(o.prototype,"dropEdgeCollection",[c],Object.getOwnPropertyDescriptor(o.prototype,"dropEdgeCollection"),o.prototype),r(o.prototype,"removeField",[c],Object.getOwnPropertyDescriptor(o.prototype,"removeField"),o.prototype),r(o.prototype,"removeIndex",[c],Object.getOwnPropertyDescriptor(o.prototype,"removeIndex"),o.prototype),r(o.prototype,"removeTimestamps",[c],Object.getOwnPropertyDescriptor(o.prototype,"removeTimestamps"),o.prototype),e=o))||e}))},p=t=>{const{initializeMixin:e,meta:o,method:i}=t.NS;t.defineMixin("/mixins/BucketCollectionMixin.js",(t=>{var n,a,s,l,c;return e((c=l=class extends t{async createFileWriteStream(t,e={}){return await this.adapter.createFileWriteStream(t,e)}async createFileReadStream(t){return await this.adapter.createFileReadStream(t)}async fileExists(t){return await this.adapter.fileExists(t)}async removeFile(t){return await this.adapter.removeFile(t)}},l.object={},r(a=c,"object",[o],(s=(s=Object.getOwnPropertyDescriptor(a,"object"))?s.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return s}}),a),r(a.prototype,"createFileWriteStream",[i],Object.getOwnPropertyDescriptor(a.prototype,"createFileWriteStream"),a.prototype),r(a.prototype,"createFileReadStream",[i],Object.getOwnPropertyDescriptor(a.prototype,"createFileReadStream"),a.prototype),r(a.prototype,"fileExists",[i],Object.getOwnPropertyDescriptor(a.prototype,"fileExists"),a.prototype),r(a.prototype,"removeFile",[i],Object.getOwnPropertyDescriptor(a.prototype,"removeFile"),a.prototype),n=a))||n}))},u=t=>{const{initializeMixin:e,meta:o,property:i,method:n}=t.NS;t.defineMixin("/mixins/QueryableMongoCollectionMixin.js",(t=>{var i,a,s,l,c;return e((c=l=class extends t{async takeBy(t,e={}){const o=await this.adapter.takeBy(this.delegate,t,e);return this._cursorFactory(this.getName(),o,"MongoCursor")}async exists(t){return await this.adapter.exists(this.delegate,t)}async executeQuery(t){const e=await this.adapter.executeQuery(this.delegate,t);return t.isCustomReturn?null!=e?this._cursorFactory(null,e,"MongoCursor"):this._cursorFactory(null,[],"Cursor"):this._cursorFactory(this.getName(),e,"MongoCursor")}},l.object={},r(a=c,"object",[o],(s=(s=Object.getOwnPropertyDescriptor(a,"object"))?s.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return s}}),a),r(a.prototype,"takeBy",[n],Object.getOwnPropertyDescriptor(a.prototype,"takeBy"),a.prototype),r(a.prototype,"exists",[n],Object.getOwnPropertyDescriptor(a.prototype,"exists"),a.prototype),r(a.prototype,"executeQuery",[n],Object.getOwnPropertyDescriptor(a.prototype,"executeQuery"),a.prototype),i=a))||i}))},y=t=>{const{Pipes:e,initializeMixin:i,meta:a,property:s,method:l,Utils:{jsonStringify:c,assert:p,inflect:u}}=t.NS,{LogMessage:y}=e.NS,{SEND_TO_LOG:d,LEVELS:h,DEBUG:b}=y,w=new Map,m=new Map;t.defineMixin("/mixins/MongoAdapterMixin.js",(t=>{var e,y,g,$,f,O,j,x,M,v,_,N,P,D,F,S;return i((S=F=class extends t{constructor(...t){super(...t),n(this,"_collection",$,this),n(this,"_db",f,this),n(this,"_host",O,this),n(this,"_port",j,this),n(this,"_dbName",x,this),n(this,"dbProto",M,this),n(this,"host",v,this),n(this,"port",_,this),n(this,"dbName",N,this),n(this,"username",P,this),n(this,"password",D,this)}get connection(){const{username:t,password:e,host:i,port:r,dbName:n,dbProto:a}=this;return null==w.get(`${i}:${r}/${n}`)&&w.set(`${i}:${r}/${n}`,(async()=>{const n=`${a}://${null!=t&&null!=e?`${t}:${e}@`:""}${i}${a.includes("+srv")?"":":"+r}/admin`;return await o.MongoClient.connect(n,{useUnifiedTopology:!0})})()),w.get(`${i}:${r}/${n}`)}get db(){return null==this._db&&(this._db=(async()=>(await this.connection).db(this._dbName))()),this._db}get collection(){return null==this._collection&&(this._collection=(async()=>{const t=await this.db,e=this.collectionName();return await new Promise(((o,i)=>{t.collection(e,{strict:!0},((t,e)=>{null!=t?i(t):o(e)}))}))})()),this._collection}collectionName(){return`${u.underscore(this.Module.name)}_${u.pluralize(u.underscore((this.getName()||"").replace(/Adapter$/,"")))}`}onRegister(){super.onRegister(...arguments);const{host:t,port:e,dbName:o}=this;this._host=t,this._port=e,this._dbName=o,(()=>{this.connection})();let i=m.get(`${t}:${e}/${o}`);i=null!=i?i:0,i++,m.set(`${t}:${e}/${o}`,i)}async onRemove(){super.onRemove(...arguments);const{_host:t,_port:e,_dbName:o}=this;let i=m.get(`${t}:${e}/${o}`);if(i--,m.set(`${t}:${e}/${o}`,i),0===i){const i=await w.get(`${t}:${e}/${o}`);await i.close(!0),w.delete(`${t}:${e}/${o}`),m.delete(`${t}:${e}/${o}`)}}async push(t,e){const o=await this.collection,i=await o.stats(),r=await o.findOne({id:{$eq:e.id}});return this.send(d,`MongoAdapterMixin::push ns = ${i.ns}, snapshot = ${c(e)}`,h[b]),p(null==r,`Record with the same id=${e.id} exists in collection`),await o.insertOne(e,{w:"majority",j:!0,wtimeout:500}),await o.findOne({id:{$eq:e.id}})}async remove(t,e){const o=await this.collection,i=await o.stats();this.send(d,`MongoAdapterMixin::remove ns = ${i.ns}, id = ${e}`,h[b]),await o.deleteOne({id:{$eq:e}},{w:"majority",j:!0,wtimeout:500})}async take(t,e){const o=await this.collection,i=await o.stats();return this.send(d,`MongoAdapterMixin::take ns = ${i.ns}, id = ${e}`,h[b]),await o.findOne({id:{$eq:e}})}async takeMany(t,e){const o=await this.collection,i=await o.stats();return this.send(d,`MongoAdapterMixin::takeMany ns = ${i.ns}, ids = ${c(e)}`,h[b]),await o.find({id:{$in:e}})}async takeAll(t){const e=await this.collection,o=await e.stats();return this.send(d,`MongoAdapterMixin::takeAll ns = ${o.ns}`,h[b]),await e.find()}async override(t,e,o){const i=await this.collection,r=await i.stats();return this.send(d,`MongoAdapterMixin::override ns = ${r.ns}, id = ${e}, snapshot = ${c(o)}`,h[b]),await i.updateOne({id:{$eq:e}},{$set:o},{multi:!0,w:"majority",j:!0,wtimeout:500}),await i.findOne({id:{$eq:e}})}async includes(t,e){const o=await this.collection,i=await o.stats();return this.send(d,`MongoAdapterMixin::includes ns = ${i.ns}, id = ${e}`,h[b]),null!=await o.findOne({id:{$eq:e}})}async length(t){const e=await this.collection,o=await e.stats();return this.send(d,`MongoAdapterMixin::length ns = ${o.ns}`,h[b]),o.count}},F.object={},r(y=S,"object",[a],(g=(g=Object.getOwnPropertyDescriptor(y,"object"))?g.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return g}}),y),$=r(y.prototype,"_collection",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),f=r(y.prototype,"_db",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),O=r(y.prototype,"_host",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j=r(y.prototype,"_port",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x=r(y.prototype,"_dbName",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M=r(y.prototype,"dbProto",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"mongodb"}}),v=r(y.prototype,"host",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"localhost"}}),_=r(y.prototype,"port",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"27017"}}),N=r(y.prototype,"dbName",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"dbName"}}),P=r(y.prototype,"username",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=r(y.prototype,"password",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r(y.prototype,"connection",[s],Object.getOwnPropertyDescriptor(y.prototype,"connection"),y.prototype),r(y.prototype,"db",[s],Object.getOwnPropertyDescriptor(y.prototype,"db"),y.prototype),r(y.prototype,"collection",[s],Object.getOwnPropertyDescriptor(y.prototype,"collection"),y.prototype),r(y.prototype,"collectionName",[l],Object.getOwnPropertyDescriptor(y.prototype,"collectionName"),y.prototype),r(y.prototype,"onRegister",[l],Object.getOwnPropertyDescriptor(y.prototype,"onRegister"),y.prototype),r(y.prototype,"onRemove",[l],Object.getOwnPropertyDescriptor(y.prototype,"onRemove"),y.prototype),r(y.prototype,"push",[l],Object.getOwnPropertyDescriptor(y.prototype,"push"),y.prototype),r(y.prototype,"remove",[l],Object.getOwnPropertyDescriptor(y.prototype,"remove"),y.prototype),r(y.prototype,"take",[l],Object.getOwnPropertyDescriptor(y.prototype,"take"),y.prototype),r(y.prototype,"takeMany",[l],Object.getOwnPropertyDescriptor(y.prototype,"takeMany"),y.prototype),r(y.prototype,"takeAll",[l],Object.getOwnPropertyDescriptor(y.prototype,"takeAll"),y.prototype),r(y.prototype,"override",[l],Object.getOwnPropertyDescriptor(y.prototype,"override"),y.prototype),r(y.prototype,"includes",[l],Object.getOwnPropertyDescriptor(y.prototype,"includes"),y.prototype),r(y.prototype,"length",[l],Object.getOwnPropertyDescriptor(y.prototype,"length"),y.prototype),e=y))||e}))},d=t=>{const{Pipes:e,initializeMixin:i,meta:a,property:s,method:l,Utils:{jsonStringify:c,assign:p}}=t.NS,{LogMessage:u}=e.NS,{SEND_TO_LOG:y,LEVELS:d,DEBUG:h}=u;t.defineMixin("/mixins/BucketAdapterMixin.js",(t=>{var e,u,b,w,m,g;return i((g=m=class extends t{constructor(...t){super(...t),n(this,"_bucket",w,this)}get bucket(){return null==this._bucket&&(this._bucket=(async()=>{const t=(await this.connection).db(`${this.dbName}_fs`);return new o.GridFSBucket(t,{chunkSizeBytes:64512,bucketName:"binary-store"})})()),this._bucket}async createFileWriteStream(t,e={}){const o=await this.bucket;this.send(y,`BucketAdapterMixin::createFileWriteStream opts = ${c(t)}`,d[h]);const i=p({},{dbName:this.dbName},e);return o.openUploadStream(t.filename,{metadata:i})}async createFileReadStream(t){const e=await this.bucket;return this.send(y,`BucketAdapterMixin::createFileReadStream opts = ${c(t)}`,d[h]),await this.fileExists(t)?e.openDownloadStreamByName(t.filename,{}):void 0}async fileExists(t){const e=await this.bucket;return this.send(y,`BucketAdapterMixin::fileExists opts = ${c(t)}`,d[h]),await await e.find({filename:t.filename}).hasNext()}async removeFile(t){const e=await this.bucket;this.send(y,`BucketAdapterMixin::removeFile opts = ${c(t)}`,d[h]);const o=await e.find({filename:t.filename}),i=await o.next();null!=i&&await e.delete(i._id)}},m.object={},r(u=g,"object",[a],(b=(b=Object.getOwnPropertyDescriptor(u,"object"))?b.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return b}}),u),w=r(u.prototype,"_bucket",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r(u.prototype,"bucket",[s],Object.getOwnPropertyDescriptor(u.prototype,"bucket"),u.prototype),r(u.prototype,"createFileWriteStream",[l],Object.getOwnPropertyDescriptor(u.prototype,"createFileWriteStream"),u.prototype),r(u.prototype,"createFileReadStream",[l],Object.getOwnPropertyDescriptor(u.prototype,"createFileReadStream"),u.prototype),r(u.prototype,"fileExists",[l],Object.getOwnPropertyDescriptor(u.prototype,"fileExists"),u.prototype),r(u.prototype,"removeFile",[l],Object.getOwnPropertyDescriptor(u.prototype,"removeFile"),u.prototype),e=u))||e}))};const h={}.hasOwnProperty;var b=t=>{const{Pipes:e,initializeMixin:o,meta:a,property:s,method:l,Utils:{_:c,jsonStringify:p,moment:u,assign:y,assert:d}}=t.NS,{LogMessage:b}=e.NS,{SEND_TO_LOG:w,LEVELS:m,DEBUG:g}=b,$=t=>c.isString(t)?/^\@doc\./.test(t)?t.replace("@doc.",""):t.replace("@",""):t,f=(t,e,o,i)=>{const r=(e=e.utc()).startOf(o).toISOString(),n=e.clone().endOf(o).toISOString();return i?{$and:[{[`${t}`]:{$gte:r},[`${t}`]:{$lt:n}}]}:{$not:{$and:[{[`${t}`]:{$gte:r},[`${t}`]:{$lt:n}}]}}};t.defineMixin("/mixins/QueryableMongoAdapterMixin.js",(t=>{var e,y,b,O,j,x;return o((x=j=class extends t{constructor(...t){super(...t),n(this,"operatorsMap",O,this)}async takeBy(t,e,o={}){const r=await this.collection,n=await r.stats(),a=this.parseFilter(t,i.parse(e));this.send(w,`QueryableMongoAdapterMixin::takeBy ns = ${n.ns}, voQuery = ${p(a)}`,m[g]);let s=await r.find(a);const l=o.$limit;null!=l&&(s=s.limit(l));const c=o.$offset;null!=c&&(s=s.skip(c));const u=o.$sort;return null!=u&&(s=s.sort(u.reduce(((t,e)=>{for(const o in e){if(!h.call(e,o))continue;const i=e[o];t[$(o)]="ASC"===i?1:-1}return t})),{})),s}async exists(t,e){const o=await this.collection,r=await o.stats(),n=this.parseFilter(t,i.parse(e));return this.send(w,`QueryableMongoAdapterMixin::exists ns = ${r.ns}, voQuery = ${p(n)}`,m[g]),0!==await o.count(n)}parseFilter(t,e){const{field:o,parts:i=[],operator:r,operand:n,implicitField:a}=e;if(null!=o&&"$elemMatch"!==r&&0===i.length){const e=t.customFilters[o];if(null!=e&&null!=e[r]){return e[r].call(this,n)}return this.operatorsMap[r](o,n)}if(null==o||"$elemMatch"!==r)return this.operatorsMap[null!=r?r:"$and"](i.map(this.parseFilter.bind(this,t)));this.operatorsMap[r](o,i.reduce(((e,o)=>{if(!a||null!=o.field||null!=o.parts&&0!==o.parts.length)return Object.assign(e,this.parseFilter(t,o));{const t=this.operatorsMap[o.operator]("temporaryField",o.operand);return Object.assign(e,t.temporaryField)}}),{}))}async parseQuery(t,e){d(null==e.$join,"`$join` not available for Mongo queries"),d(null==e.$let,"`$let` not available for Mongo queries"),d(null==e.$aggregate,"`$aggregate` not available for Mongo queries");const o={};let r=!1;if(null!=e.$remove){if(null!=e.$into&&(o.queryType="removeBy",null!=e.$forIn)){o.pipeline=[];const n=e.$filter;null!=n&&o.pipeline.push({$match:this.parseFilter(t,i.parse(n))});const a=e.$sort;null!=a&&o.pipeline.push({$sort:a.reduce(((t,e)=>{for(const o in e){if(!h.call(e,o))continue;const i=e[o];t[$(o)]="ASC"===i?1:-1}return t}),{})});const s=e.$offset;null!=s&&o.pipeline.push({$skip:s});const l=e.$limit;return null!=l&&o.pipeline.push({$limit:l}),r=!0,o}}else if(null!=e.$patch){if(null!=e.$into&&(o.queryType="patchBy",null!=e.$forIn)){o.pipeline=[];const n=e.$filter;null!=n&&o.pipeline.push({$match:this.parseFilter(t,i.parse(n))});const a=e.$sort;null!=a&&o.pipeline.push({$sort:a.reduce(((t,e)=>{for(const o in e){if(!h.call(e,o))continue;const i=e[o];t[$(o)]="ASC"===i?1:-1}return t}),{})});const s=e.$offset;null!=s&&o.pipeline.push({$skip:s});const l=e.$limit;return null!=l&&o.pipeline.push({$limit:l}),o.patch=e.$patch,r=!0,o}}else if(null!=e.$forIn){o.queryType="query",o.pipeline=[];const n=e.$filter;null!=n&&o.pipeline.push({$match:this.parseFilter(t,i.parse(n))});const a=e.$sort;null!=a&&o.pipeline.push({$sort:a.reduce(((t,e)=>{for(const o in e){if(!h.call(e,o))continue;const i=e[o];t[$(o)]="ASC"===i?1:-1}return t}),{})});const s=e.$offset;null!=s&&o.pipeline.push({$skip:s});const l=e.$limit;null!=l&&o.pipeline.push({$limit:l});if(null!=e.$collect){r=!0;const n={};for(const t in item){if(!h.call(item,t))continue;item[t];n[$(void 0)]=$(void 0)}const a=e.$into,s=null!=a?$(a):"GROUP";o.pipeline.push({$group:{_id:n,[`${s}`]:{$push:Object.keys(t.attributes).reduce((function(t,e){return t[e]=`$${e}`,t}),{})}}});const l=e.$having;if(null!=l&&o.pipeline.push({$match:this.parseFilter(t,i.parse(l))}),null!=e.$count)r=!0,o.pipeline.push({$count:"result"});else{const t=e.$sum;if(null!=t)r=!0,o.pipeline.push({$group:{_id:null,result:{$sum:`${$(t)}`}}}),o.pipeline.push({$project:{_id:0}});else{const t=e.$min;if(null!=t)r=!0,o.pipeline.push({$sort:{[`${$(t)}`]:1}}),o.pipeline.push({$limit:1}),o.pipeline.push({$project:{_id:0,result:`${$(t)}`}});else{const t=e.$max;if(null!=t)r=!0,o.pipeline.push({$sort:{[`${$(t)}`]:-1}}),o.pipeline.push({$limit:1}),o.pipeline.push({$project:{_id:0,result:`${$(t)}`}});else{const t=e.$avg;if(null!=t)r=!0,o.pipeline.push({$group:{_id:null,result:{$avg:`${$(t)}`}}}),o.pipeline.push({$project:{_id:0}});else{const t=e.$return;if(null!=t)"@doc"!==t&&(r=!0),c.isString(t)&&"@doc"!==t&&o.pipeline.push({$project:{_id:0,[`${$(t)}`]:1}});else if(c.isObject(t))for(key in t){if(h.call(t,key))continue;t[key]}e.$distinct&&o.pipeline.push({$group:{_id:"$$CURRENT"}})}}}}}}}return o.isCustomReturn=null!=r&&r,o}async executeQuery(t,e){const o=await this.collection,i=await o.stats();this.send(w,`QueryableMongoAdapterMixin::executeQuery ns = ${i.ns}, aoQuery = ${p(e)}`,m[g]);let r=null;switch(e.queryType){case"query":r=await o.aggregate(e.pipeline,{cursor:{batchSize:1}});break;case"patchBy":{const t=e.pipeline;t.push({$project:{_id:1}});const i=MongoCursor.new(null,await o.aggregate(t,{cursor:{batchSize:1e3}})),n=await i.map(co.wrap((t=>t._id)));r=await o.updateMany({_id:{$in:n}},{$set:e.patch},{multi:!0,w:"majority",j:!0,wtimeout:500},null);break}case"removeBy":{const t=e.pipeline;t.push({$project:{_id:1}});const i=MongoCursor.new(null,await o.aggregate(t,{cursor:{batchSize:1e3}})),n=await i.map(co.wrap((t=>t._id)));r=await o.deleteMany({_id:{$in:n}},{w:"majority",j:!0,wtimeout:500},null);break}}return r}},j.object={},r(y=x,"object",[a],(b=(b=Object.getOwnPropertyDescriptor(y,"object"))?b.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return b}}),y),r(y.prototype,"takeBy",[l],Object.getOwnPropertyDescriptor(y.prototype,"takeBy"),y.prototype),r(y.prototype,"exists",[l],Object.getOwnPropertyDescriptor(y.prototype,"exists"),y.prototype),O=r(y.prototype,"operatorsMap",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{$and:t=>({$and:t}),$or:t=>({$or:t}),$not:t=>({$not:t}),$nor:t=>({$nor:t}),$eq:(t,e)=>({[`${$(t)}`]:{$eq:$(e)}}),$ne:(t,e)=>({[`${$(t)}`]:{$ne:$(e)}}),$lt:(t,e)=>({[`${$(t)}`]:{$lt:$(e)}}),$lte:(t,e)=>({[`${$(t)}`]:{$lte:$(e)}}),$gt:(t,e)=>({[`${$(t)}`]:{$gt:$(e)}}),$gte:(t,e)=>({[`${$(t)}`]:{$gte:$(e)}}),$in:(t,e)=>({[`${$(t)}`]:{$in:e}}),$nin:(t,e)=>({[`${$(t)}`]:{$nin:e}}),$all:(t,e)=>({[`${$(t)}`]:{$all:e}}),$elemMatch:(t,e)=>({[`${$(t)}`]:{$elemMatch:e}}),$size:(t,e)=>({[`${$(t)}`]:{$size:e}}),$exists:(t,e)=>({[`${$(t)}`]:{$exists:e}}),$type:(t,e)=>({[`${$(t)}`]:{$type:e}}),$mod:(t,e)=>({[`${$(t)}`]:{$mod:e}}),$regex:(t,e,o)=>{const i=/^\/([\s\S]*)\/(i?m?)$/i.exec(e);if(null==i)throw new Error("Invalid Regular Expression");const[r,n,a]=i,s={$regex:new RegExp(n,a)};return null!=o&&(s.$options=o),{[`${$(t)}`]:s}},$text:()=>{throw new Error("Not supported")},$where:()=>{throw new Error("Not supported")},$td:(t,e)=>f($(t),u(),"day",e),$ld:(t,e)=>f($(t),u().subtract(1,"days"),"day",e),$tw:(t,e)=>f($(t),u(),"week",e),$lw:(t,e)=>f($(t),u().subtract(1,"weeks"),"week",e),$tm:(t,e)=>f($(t),u(),"month",e),$lm:(t,e)=>f($(t),u().subtract(1,"months"),"month",e),$ty:(t,e)=>f($(t),u(),"year",e),$ly:(t,e)=>f($(t),u().subtract(1,"years"),"year",e)}}}),r(y.prototype,"parseFilter",[l],Object.getOwnPropertyDescriptor(y.prototype,"parseFilter"),y.prototype),r(y.prototype,"parseQuery",[l],Object.getOwnPropertyDescriptor(y.prototype,"parseQuery"),y.prototype),r(y.prototype,"executeQuery",[l],Object.getOwnPropertyDescriptor(y.prototype,"executeQuery"),y.prototype),e=y))||e}))},w=t=>{const{initializeMixin:e,meta:o,method:i}=t.NS;t.defineMixin("/mixins/MongoFacadeMixin.js",(t=>{var n,a,s,l,c;return e((c=l=class extends t{initializeFacade(){super.initializeFacade(...arguments),this.isBound("MongoCursor")||this.bind("MongoCursor").to(this.Module.NS.MongoCursor)}},l.object={},r(a=c,"object",[o],(s=(s=Object.getOwnPropertyDescriptor(a,"object"))?s.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return s}}),a),r(a.prototype,"initializeFacade",[i],Object.getOwnPropertyDescriptor(a.prototype,"initializeFacade"),a.prototype),n=a))||n}))};module.exports=t=>{const{initializeMixin:e,meta:o,extend:i}=t.NS;return["MongoAddon",t=>{var n,h,m,g,$;return i("MongoFacadeMixin","Facade")(n=w(n=b(n=d(n=y(n=u(n=p(n=s(n=c(n=l(n=a(n=e(($=g=class extends t{},g.object={},r(h=$,"object",[o],(m=(m=Object.getOwnPropertyDescriptor(h,"object"))?m.value:void 0,{enumerable:!0,configurable:!0,writable:!0,initializer:function(){return m}}),h),n=h))||n)||n)||n)||n)||n)||n)||n)||n)||n)||n)||n)||n}]};
